<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Organization Manager</title>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonte Google: Inter para visual moderno -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Default Dark Theme */
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-header: #1f2937;
            --text-main: #f9fafb;
            --text-secondary: #9ca3af;
            --primary: #6366f1;
            --primary-hover: #818cf8;
            --border: #374151;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --accent-info: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --radius: 12px;
        }

        /* Themes */
        [data-theme="light"] {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-header: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="solarized"] {
            --bg-body: #fdf6e3;
            --bg-card: #eee8d5;
            --bg-header: #eee8d5;
            --text-main: #073642;
            --text-secondary: #586e75;
            --primary: #b58900;
            --primary-hover: #cb4b16;
            --border: #93a1a1;
        }

        [data-theme="cyberpunk"] {
            --bg-body: #000b1e;
            --bg-card: #051636;
            --bg-header: #051636;
            --text-main: #fcee0a;
            --text-secondary: #00f0ff;
            --primary: #ff003c;
            --primary-hover: #ff0055;
            --border: #00f0ff;
            --radius: 0px; /* Sharp edges */
        }

        [data-theme="matrix"] {
            --bg-body: #000000;
            --bg-card: #0d0d0d;
            --bg-header: #0a0a0a;
            --text-main: #00ff41;
            --text-secondary: #008f11;
            --primary: #003b00; /* Dark green */
            --primary-hover: #00ff41;
            --border: #003b00;
        }

        [data-theme="dracula"] {
            --bg-body: #282a36;
            --bg-card: #44475a;
            --bg-header: #44475a;
            --text-main: #f8f8f2;
            --text-secondary: #6272a4;
            --primary: #bd93f9;
            --primary-hover: #ff79c6;
            --border: #6272a4;
        }

        /* --- GLOBAL RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; transition: background-color 0.3s, color 0.3s; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .btn { padding: 10px 20px; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 500; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background-color: var(--accent-danger); color: white; }
        .btn-success { background-color: var(--accent-success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* --- HEADER --- */
        header { background-color: var(--bg-header); padding: 1rem 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo h1 { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo p { font-size: 0.85rem; color: var(--text-secondary); }
        .user-controls { display: flex; align-items: center; gap: 1rem; }
        .user-info { text-align: right; font-size: 0.9rem; }
        .user-name { font-weight: 600; display: block; }
        .user-email { font-size: 0.75rem; color: var(--text-secondary); }
        
        /* Theme Switcher */
        .theme-switcher { display: flex; gap: 5px; }
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; }

        /* --- LOADER --- */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- DASHBOARD --- */
        .section-title { margin: 2rem 0 1rem; font-size: 1.25rem; font-weight: 600; border-left: 4px solid var(--primary); padding-left: 1rem; }
        
        .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; justify-content: center; }
        
        .card { background-color: var(--bg-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; transition: transform 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Config Cards */
        .config-card { cursor: pointer; text-align: center; justify-content: center; align-items: center; height: 100%; min-height: 180px; }
        .config-icon { font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem; }
        .config-label { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .config-subtitle { font-size: 0.9rem; color: var(--text-secondary); }

        /* Project Cards */
        .project-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .project-type { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); font-weight: 600; background: var(--bg-body); padding: 4px 8px; border-radius: 4px; }
        .project-status { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; font-weight: 700; }
        .status-active { color: var(--accent-success); background: rgba(16, 185, 129, 0.1); }
        .status-inactive { color: var(--accent-danger); background: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-danger); }
        .status-finished { color: var(--accent-info); background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-info); }
        
        .project-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .project-date { font-size: 0.9rem; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; margin-bottom: 1.5rem; }
        .card-actions { margin-top: auto; display: flex; justify-content: space-between; gap: 10px; }
        
        /* --- PROJECT DETAILS VIEW --- */
        .project-header-detail { background: var(--bg-card); padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 2rem; border: 1px solid var(--border); }
        .budget-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .budget-item label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .budget-item span { font-size: 1.5rem; font-weight: 700; }
        
        .progress-container { margin-top: 1.5rem; }
        .progress-bar { height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent-success); width: 0%; transition: width 0.5s ease; }
        
        .alert-budget { background-color: rgba(239, 68, 68, 0.1); color: var(--accent-danger); padding: 10px; border-radius: var(--radius); margin-top: 1rem; border: 1px solid var(--accent-danger); display: flex; align-items: center; gap: 10px; }

        .category-section { margin-bottom: 2rem; }
        .category-title { font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .items-list { display: flex; flex-direction: column; gap: 10px; }
        .item-row { background: var(--bg-card); padding: 1rem; border-radius: var(--radius); display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); }
        .item-info { display: flex; align-items: center; gap: 15px; flex: 1; }
        .item-check { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        .item-name { font-weight: 500; }
        .item-value { font-weight: 600; margin-right: 15px; }
        .completed-text { text-decoration: line-through; color: var(--text-secondary); }

        .form-add-item { background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); margin-bottom: 2rem; display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; border: 1px solid var(--border); }
        .form-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--text-secondary); }
        .form-control { width: 100%; padding: 10px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-family: inherit; }
        
        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: var(--radius); padding: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); animation: slideUp 0.3s ease; }
        .modal h2 { margin-bottom: 1.5rem; color: var(--primary); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 10px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- FOOTER --- */
        footer { margin-top: auto; background-color: var(--bg-header); padding: 2rem 0; border-top: 1px solid var(--border); text-align: center; font-size: 0.9rem; color: var(--text-secondary); }

        /* Responsive */
        @media (max-width: 768px) {
            .form-add-item { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; text-align: center; }
            .user-controls { width: 100%; justify-content: center; }
            .user-info { text-align: center; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p>Carregando...</p>
    </div>

    <!-- Header -->
    <header>
        <div class="container header-content">
            <div class="logo">
                <h1>LifeOrganizer <i class="fa-solid fa-cube"></i></h1>
                <p>Organize suas mudanças, viagens e projetos pessoais.</p>
            </div>
            <div class="user-controls">
                <div class="theme-switcher">
                    <div class="theme-btn" style="background:#fff" onclick="app.setTheme('light')" title="Light"></div>
                    <div class="theme-btn" style="background:#1f2937" onclick="app.setTheme('dark')" title="Dark"></div>
                    <div class="theme-btn" style="background:#fdf6e3" onclick="app.setTheme('solarized')" title="Solarized"></div>
                    <div class="theme-btn" style="background:#000b1e; border-color: #00f0ff" onclick="app.setTheme('cyberpunk')" title="Cyberpunk"></div>
                    <div class="theme-btn" style="background:#000; border-color: #00ff41" onclick="app.setTheme('matrix')" title="Matrix"></div>
                    <div class="theme-btn" style="background:#282a36; border-color: #bd93f9" onclick="app.setTheme('dracula')" title="Dracula"></div>
                </div>
                <div class="user-info">
                    <span id="user-name" class="user-name">Usuário</span>
                    <span id="user-email" class="user-email">email@exemplo.com</span>
                </div>
                <button onclick="app.logout()" class="btn btn-outline btn-sm"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app" class="container">
        <!-- Views will be injected here -->
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>Desenvolvido por Daniel Aleixo Correa em 2026, Lins SP.</p>
            <p>Sistema para gerenciamento pessoal e organização de tarefas.</p>
        </div>
    </footer>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const BASE_API = ["localhost", "127.0.0.1", ""].includes(window.location.hostname)
            ? "http://localhost:8082/api"
            : "https://personal-organization.onrender.com/api";

        // --- STATE MANAGEMENT ---
        const state = {
            token: localStorage.getItem('auth_token'),
            user: null,
            currentView: 'dashboard',
            currentProject: null,
            configTypes: [],
            activeProjects: [],
            historyProjects: []
        };

        // --- UTILS & API ---
        const utils = {
            getHeaders: () => {
                const headers = { 'Content-Type': 'application/json' };
                if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
                return headers;
            },

            showLoader: (show) => {
                const loader = document.getElementById('loader');
                if (show) loader.classList.remove('hidden');
                else loader.classList.add('hidden');
            },

            formatCurrency: (value) => {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            },

            formatDate: (dateString) => {
                if(!dateString) return 'Data não definida';
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },

            decodeToken: (token) => {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) {
                    return null;
                }
            }
        };

        const api = {
            async request(endpoint, options = {}) {
                utils.showLoader(true);
                const url = `${BASE_API}${endpoint}`;
                const config = {
                    ...options,
                    headers: utils.getHeaders()
                };

                try {
                    const response = await fetch(url, config);
                    const data = await response.json();

                    if (!response.ok) {
                        // Handle 401/403
                        if (response.status === 401 || response.status === 403) {
                            app.logout();
                            return;
                        }
                        // Alert API Error Message
                        alert(data.message || 'Erro na requisição');
                        throw new Error(data.message);
                    }
                    return data;
                } catch (error) {
                    console.error("API Error:", error);
                    throw error;
                } finally {
                    utils.showLoader(false);
                }
            }
        };

        // --- APP LOGIC ---
        const app = {
            init: () => {
                app.loadUser();
                app.router();
                // O tema padrão agora é definido via CSS (:root), não precisa setar explicitamente JS no init
                // a menos que haja algo salvo no localStorage (opcional)
            },

            loadUser: () => {
                if (!state.token) {
                    // Se não tiver token, mas a página não é index.html, deveria redirecionar
                    // Como estamos numa SPA, assumimos que esta É a página principal.
                    // O requisito diz que o botão de logout vai para index.html. 
                    // Vou assumir que esta é a página "logada".
                    document.getElementById('user-name').textContent = "Usuário Anônimo";
                    document.getElementById('user-email').textContent = "";
                } else {
                    const payload = utils.decodeToken(state.token);
                    if (payload && (payload.name || payload.sub)) { // sub often holds email/id
                        document.getElementById('user-name').textContent = payload.name || "Usuário";
                        document.getElementById('user-email').textContent = payload.email || payload.sub || "";
                    } else {
                        document.getElementById('user-name').textContent = "Usuário Anônimo";
                    }
                }
            },

            setTheme: (themeName) => {
                document.documentElement.setAttribute('data-theme', themeName);
            },

            logout: () => {
                localStorage.removeItem('auth_token');
                window.location.href = 'index.html'; 
            },

            // --- NAVIGATION ---
            router: () => {
                const main = document.getElementById('app');
                main.innerHTML = ''; // Clear views

                if (state.currentView === 'dashboard') {
                    app.views.renderDashboard();
                } else if (state.currentView === 'project') {
                    app.views.renderProjectDetail();
                }
            },

            navigateTo: (view, data = null) => {
                state.currentView = view;
                if (data) state.currentProject = data;
                app.router();
            },

            // --- VIEWS ---
            views: {
                renderDashboard: async () => {
                    const main = document.getElementById('app');
                    
                    // Fetch Data
                    try {
                        const [types, activeProjects, inactiveProjects, finishedProjects] = await Promise.all([
                            api.request('/project-types'),
                            api.request('/projects?status=ACTIVE'),
                            api.request('/projects?status=INACTIVE'),
                            api.request('/projects?status=FINISHED')
                        ]);
                        
                        state.configTypes = types;
                        state.activeProjects = activeProjects;
                        // Filter history
                        state.historyProjects = [...inactiveProjects, ...finishedProjects];
                    } catch (e) {
                        return; // Error handled in api.request
                    }

                    // 1. Active Projects Section
                    let html = `<div id="dashboard-view">`;
                    
                    // Active List
                    html += `<h2 class="section-title">Projetos Ativos</h2>`;
                    html += `<div class="grid-cards">`;
                    if (state.activeProjects.length === 0) {
                        html += `<p class="text-secondary">Nenhum projeto ativo no momento.</p>`;
                    } else {
                        state.activeProjects.forEach(p => {
                            html += app.components.projectCard(p, true);
                        });
                    }
                    html += `</div>`;

                    // 2. Configuration Cards (Create New)
                    html += `<h2 class="section-title">Começar Novo Projeto</h2>`;
                    html += `<div class="grid-cards">`;
                    state.configTypes.forEach(type => {
                        if (type.active) {
                            html += `
                                <div class="card config-card" onclick="app.handlers.openCreateModal('${type.id}', '${type.label}')">
                                    <div class="config-icon"><i class="${type.icon}"></i></div>
                                    <div class="config-label">${type.label}</div>
                                    <div class="config-subtitle">${type.subtitle}</div>
                                </div>
                            `;
                        }
                    });
                    html += `</div>`;

                    // 3. History (Inactive/Finished)
                    html += `<h2 class="section-title">Histórico</h2>`;
                    html += `<div class="grid-cards">`;
                    if (state.historyProjects.length === 0) {
                        html += `<p style="color:var(--text-secondary)">Nenhum projeto finalizado ou inativo.</p>`;
                    } else {
                        state.historyProjects.forEach(p => {
                            html += app.components.projectCard(p, false);
                        });
                    }
                    html += `</div></div>`;

                    main.innerHTML = html;
                },

                renderProjectDetail: async () => {
                    const main = document.getElementById('app');
                    const projectId = state.currentProject.id;

                    try {
                        // Get Project Details and Items
                        const [projectData, itemsData] = await Promise.all([
                            api.request(`/projects/${projectId}`),
                            api.request(`/projects/${projectId}/items`)
                        ]);
                        
                        // Update local state details
                        state.currentProject = projectData;

                        // Calculate Logic
                        const budget = projectData.budget;
                        const items = itemsData || [];
                        
                        // Progress Logic
                        // Viagem: Barra de progresso baseada em custos (gasto / planejado)
                        // Mudança/Outros: Baseada em itens completados
                        let progressPercent = 0;
                        let totalSpent = 0;

                        items.forEach(i => totalSpent += i.value);

                        if (projectData.type === 'viagem' || projectData.type === 'travel') {
                             if (budget > 0) {
                                progressPercent = (totalSpent / budget) * 100;
                                if(progressPercent > 100) progressPercent = 100;
                             }
                        } else {
                            const totalItems = items.length;
                            const completedItems = items.filter(i => i.completed).length;
                            if (totalItems > 0) {
                                progressPercent = (completedItems / totalItems) * 100;
                            }
                        }

                        const remaining = budget - totalSpent;
                        const isBudgetExceeded = remaining < 0;

                        // Build HTML
                        let html = `<div id="project-view">`;
                        
                        // Back Button
                        html += `<button class="btn btn-outline" style="margin-bottom:1rem" onclick="app.navigateTo('dashboard')"><i class="fa-solid fa-arrow-left"></i> Voltar</button>`;

                        // Header Detail
                        html += `
                            <div class="project-header-detail">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start">
                                    <div>
                                        <h2 style="font-size:2rem; color:var(--primary)">${projectData.title}</h2>
                                        <p style="color:var(--text-secondary)">${utils.formatDate(projectData.date)} - <span class="project-type">${projectData.type}</span></p>
                                    </div>
                                    <div class="project-status status-${projectData.status.toLowerCase()}">${projectData.status}</div>
                                </div>

                                <div class="budget-info">
                                    <div class="budget-item">
                                        <label>Orçamento Planejado</label>
                                        <span style="color:var(--text-main)">${utils.formatCurrency(budget)}</span>
                                    </div>
                                    <div class="budget-item">
                                        <label>Total Gasto</label>
                                        <span style="color:var(--accent-info)">${utils.formatCurrency(totalSpent)}</span>
                                    </div>
                                    <div class="budget-item">
                                        <label>Saldo Restante</label>
                                        <span style="color: ${isBudgetExceeded ? 'var(--accent-danger)' : 'var(--accent-success)'}">${utils.formatCurrency(remaining)}</span>
                                    </div>
                                </div>

                                ${isBudgetExceeded ? `<div class="alert-budget"><i class="fa-solid fa-triangle-exclamation"></i> Alerta: O orçamento planejado foi estourado!</div>` : ''}

                                <div class="progress-container">
                                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px">
                                        <span>Progresso (${projectData.type === 'viagem' ? 'Custos' : 'Conclusão'})</span>
                                        <span>${progressPercent.toFixed(0)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Add Item Form
                        html += `
                            <form class="form-add-item" onsubmit="app.handlers.addItem(event, '${projectId}')">
                                <div class="form-group">
                                    <label>Descrição do Item</label>
                                    <input type="text" name="name" class="form-control" placeholder="Ex: Geladeira, Passagem..." required>
                                </div>
                                <div class="form-group">
                                    <label>Categoria</label>
                                    <select name="category" class="form-control" required>
                                        ${projectData.selectedCategories.map(cat => `<option value="${cat.value}">${cat.value}</option>`).join('')}
                                        <option value="Outros">Outros</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Valor (R$)</label>
                                    <input type="number" name="value" class="form-control" placeholder="0.00" step="0.01">
                                </div>
                                <button type="submit" class="btn btn-primary" style="height: 42px;"><i class="fa-solid fa-plus"></i> Adicionar</button>
                            </form>
                        `;

                        // Items List (Grouped by Category)
                        // Group logic
                        const groupedItems = {};
                        // Initialize groups based on config to ensure order (optional, but good)
                        projectData.selectedCategories.forEach(c => groupedItems[c.value] = []);
                        groupedItems["Outros"] = [];

                        items.forEach(item => {
                            const cat = item.category || "Outros";
                            if (!groupedItems[cat]) groupedItems[cat] = [];
                            groupedItems[cat].push(item);
                        });

                        html += `<div class="items-container">`;
                        
                        for (const [category, catItems] of Object.entries(groupedItems)) {
                            if (catItems.length === 0) continue;

                            html += `
                                <div class="category-section">
                                    <h3 class="category-title"><i class="fa-solid fa-folder-open"></i> ${category}</h3>
                                    <div class="items-list">
                                        ${catItems.map(item => `
                                            <div class="item-row">
                                                <div class="item-info">
                                                    <input type="checkbox" class="item-check" 
                                                        ${item.completed ? 'checked' : ''} 
                                                        onchange="app.handlers.toggleItem('${projectId}', '${item.id}', this.checked)">
                                                    
                                                    <div style="flex:1">
                                                        <div class="item-name ${item.completed ? 'completed-text' : ''}">${item.name}</div>
                                                    </div>
                                                </div>
                                                <div style="display:flex; align-items:center;">
                                                    <div class="item-value">${utils.formatCurrency(item.value)}</div>
                                                    <button class="btn btn-outline btn-sm" onclick="app.handlers.openEditValueModal('${projectId}', '${item.id}', ${item.value})"><i class="fa-solid fa-pen"></i></button>
                                                    <button class="btn btn-outline btn-sm" style="color:var(--accent-danger); border:none" onclick="app.handlers.deleteItem('${projectId}', '${item.id}')"><i class="fa-solid fa-trash"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        html += `</div></div>`; // End container

                        main.innerHTML = html;

                    } catch (e) {
                        console.error(e);
                        main.innerHTML = `<p class="text-danger">Erro ao carregar projeto.</p>`;
                    }
                }
            },

            // --- COMPONENTS (HTML Generators) ---
            components: {
                projectCard: (project, isActive) => {
                    return `
                        <div class="card project-card ${!isActive ? (project.status === 'FINISHED' ? 'border-blue' : 'border-red') : ''}">
                            <div class="card-header">
                                <span class="project-type">${project.type}</span>
                                <span class="project-status status-${project.status.toLowerCase()}">${project.status}</span>
                            </div>
                            <div class="project-title">${project.title}</div>
                            <div class="project-date"><i class="fa-regular fa-calendar"></i> ${utils.formatDate(project.date)}</div>
                            
                            <div class="card-actions">
                                ${isActive ? `
                                    <button class="btn btn-primary" onclick="app.navigateTo('project', {id: '${project.id}'})">Entrar</button>
                                    <div style="display:flex; gap:5px">
                                        <button class="btn btn-outline" title="Finalizar" onclick="app.handlers.changeStatus('${project.id}', 'FINISHED')"><i class="fa-solid fa-check"></i></button>
                                        <button class="btn btn-outline" title="Desativar" style="color:var(--accent-danger); border-color:var(--accent-danger)" onclick="app.handlers.changeStatus('${project.id}', 'INACTIVE')"><i class="fa-solid fa-power-off"></i></button>
                                    </div>
                                ` : `
                                    <button class="btn btn-outline" disabled style="opacity:0.5">Arquivado</button>
                                `}
                            </div>
                        </div>
                    `;
                }
            },

            // --- HANDLERS (Events) ---
            handlers: {
                openCreateModal: (typeId, typeLabel) => {
                    const modalHtml = `
                        <div class="modal-overlay" id="modal-create" onclick="if(event.target === this) this.remove()">
                            <div class="modal">
                                <h2>Novo Projeto: ${typeLabel}</h2>
                                <form onsubmit="app.handlers.createProject(event, '${typeId}')">
                                    <div class="form-group" style="margin-bottom:15px">
                                        <label>Título do Projeto</label>
                                        <input type="text" name="title" class="form-control" required placeholder="Ex: Casa Nova 2026">
                                    </div>
                                    <div class="form-group" style="margin-bottom:15px">
                                        <label>Data Alvo</label>
                                        <input type="date" name="date" class="form-control" required>
                                    </div>
                                    <div class="form-group" style="margin-bottom:15px">
                                        <label>Orçamento Estimado (R$)</label>
                                        <input type="number" name="budget" class="form-control" required min="1" step="0.01">
                                        <small style="color:var(--text-secondary)">Valor 0 não é permitido.</small>
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn btn-outline" onclick="document.getElementById('modal-create').remove()">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Criar Projeto</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    document.getElementById('modal-container').innerHTML = modalHtml;
                },

                createProject: async (e, type) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const payload = {
                        type: type, // prompt says "type é pego do modal"
                        title: formData.get('title'),
                        date: formData.get('date'),
                        budget: parseFloat(formData.get('budget')),
                        status: "ACTIVE"
                    };

                    try {
                        await api.request('/projects', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        document.getElementById('modal-create').remove();
                        app.views.renderDashboard(); // Reload
                    } catch (err) {
                        // Error handled in api.request (alert)
                    }
                },

                changeStatus: async (id, newStatus) => {
                    if(!confirm(`Deseja alterar o status para ${newStatus}?`)) return;
                    try {
                        await api.request(`/projects/${id}/status`, {
                            method: 'PATCH',
                            body: JSON.stringify({ status: newStatus })
                        });
                        app.views.renderDashboard();
                    } catch (err) {}
                },

                addItem: async (e, projectId) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const val = formData.get('value');
                    
                    const payload = {
                        name: formData.get('name'),
                        value: val ? parseFloat(val) : 0,
                        category: formData.get('category')
                    };

                    try {
                        await api.request(`/projects/${projectId}/items`, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        e.target.reset();
                        app.views.renderProjectDetail(); // Refresh list & totals
                    } catch (err) {}
                },

                toggleItem: async (projectId, itemId, completed) => {
                    try {
                        await api.request(`/projects/${projectId}/items/${itemId}/completed`, {
                            method: 'PATCH',
                            body: JSON.stringify({ completed: completed })
                        });
                        app.views.renderProjectDetail(); // Refresh progress
                    } catch (err) {}
                },

                deleteItem: async (projectId, itemId) => {
                   if(!confirm("Excluir item?")) return;
                   // Prompt mentions "deve ter um excluir", assuming standard REST DELETE
                   // Since no endpoint specified, attempting standard REST pattern
                   // Or reusing the prompt pattern if hidden somewhere. 
                   // Using a safe assumption or omitting if strictness required. 
                   // I will assume DELETE method on items endpoint.
                   try {
                       await api.request(`/projects/${projectId}/items/${itemId}`, {
                           method: 'DELETE'
                       });
                       app.views.renderProjectDetail();
                   } catch (err) {
                       // Fallback if DELETE not supported by this specific mock API logic
                       alert("Funcionalidade de exclusão pendente de suporte na API.");
                   }
                },

                openEditValueModal: (projectId, itemId, currentValue) => {
                     const modalHtml = `
                        <div class="modal-overlay" id="modal-edit" onclick="if(event.target === this) this.remove()">
                            <div class="modal">
                                <h2>Editar Valor</h2>
                                <form onsubmit="app.handlers.updateItemPrice(event, '${projectId}', '${itemId}')">
                                    <div class="form-group" style="margin-bottom:15px">
                                        <label>Novo Valor (R$)</label>
                                        <input type="number" name="value" class="form-control" required step="0.01" value="${currentValue}">
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn btn-outline" onclick="document.getElementById('modal-edit').remove()">Cancelar</button>
                                        <button type="submit" class="btn btn-primary">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    document.getElementById('modal-container').innerHTML = modalHtml;
                },

                updateItemPrice: async (e, projectId, itemId) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const value = parseFloat(formData.get('value'));

                    try {
                        await api.request(`/projects/${projectId}/items/${itemId}/price`, {
                            method: 'PATCH',
                            body: JSON.stringify({ value: value })
                        });
                        document.getElementById('modal-edit').remove();
                        app.views.renderProjectDetail();
                    } catch(err) {}
                }
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>